---
- name: Ensure app directory exists
  file:
    path: /opt/app
    state: directory
    mode: '0755'
    owner: ubuntu
    group: ubuntu

- name: Copy Spring JAR to server
  copy:
    src: files/expenses-tracker.jar
    dest: /opt/app/expenses-tracker.jar
    owner: ubuntu
    group: ubuntu
    mode: '0755'

- name: Copy application.properties to app server
  copy:
    src:  files/application.properties
    dest: /opt/app/application.properties
    owner: ubuntu
    group: ubuntu
    mode: '0644'
- name: Copy Dockerfile
  copy:
    src: files/Dockerfile
    dest: /opt/app/Dockerfile
    owner: ubuntu
    group: ubuntu
    mode: '0644'

- name: Stop any running app container
  become: yes
  command: docker stop spring-app
  ignore_errors: yes

- name: Remove old container if exists
  become: yes
  command: docker rm spring-app
  ignore_errors: yes

- name: Build Spring Docker image
  become: yes
  command: docker build -t spring-app .
  args:
    chdir: /opt/app/

- name: Install Trivy
  become: yes
  shell: |
    apt-get update
    apt-get install -y wget
    wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.67.2_Linux-64bit.deb
    dpkg -i trivy_0.67.2_Linux-64bit.deb
  args:
    creates: /usr/local/bin/trivy


- name: Run Trivy Image Scan
  shell: |
    trivy image --format table \
                --severity HIGH,CRITICAL \
                --ignore-unfixed \
                petclinic-app:latest
  register: trivy_scan
  ignore_errors: yes

- name: Run app container
  become: yes
  docker_container:
    name: spring-app
    image: spring-app
    state: started
    restart_policy: always
    ports:
      - "8080:8080"

- name: Verify running containers
  become: yes
  command: docker ps
  register: docker_ps_output

- name: Show running container info
  debug:
    var: docker_ps_output.stdout

